---
import '@/styles/global.css';

import CookieBanner from '@components/svelte/CookieBanner.svelte';
import GoToTop from '@components/svelte/GoToTop.svelte';
import type { Locale } from '@type/locale';
import type { ISEOMetadata } from '@type/seo';

import Footer from './Footer.astro';
import Head from './Head.astro';
import Header from './Header.astro';

export interface Props extends ISEOMetadata {
    locale: Locale;
    translationPath?: string;
}

const { locale, translationPath, ...seoProps } = Astro.props as Props;
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang={locale}>
    <head>
        <!-- Initialize dark mode immediately to prevent flash, and persist across view transitions -->
        <script is:inline nonce={Astro.locals.nonce}>
            function applyTheme() {
                const theme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = theme === 'dark' || (!theme && systemPrefersDark);

                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            // Apply theme immediately on page load
            applyTheme();

            // Reapply theme after view transitions (client-side navigation)
            document.addEventListener('astro:after-swap', applyTheme);
        </script>

        <Head {...seoProps} locale={locale} />
    </head>

    <body class="bg-page-bg text-text-primary transition-colors dark:bg-page-bg-dark dark:text-text-primary-dark">
        <Header locale={locale} currentPath={currentPath} {...translationPath ? { translationPath } : {}} />

        <main class="bg-dots min-h-screen transition-all">
            <slot />
        </main>

        <Footer locale={locale} />

        <GoToTop client:idle />

        <CookieBanner client:idle locale={locale} />
    </body>
</html>
