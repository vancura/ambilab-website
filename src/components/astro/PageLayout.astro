---
/**
 * PageLayout Component
 *
 * Root layout component that wraps all page content.
 * Provides the complete HTML structure with head, header,
 * main content area, footer, and interactive components
 * (cookie banner, go-to-top button).
 *
 * Features:
 * - Complete HTML document structure
 * - Dark mode initialization (prevents flash of unstyled content)
 * - SEO head section via Head component
 * - Sticky header with navigation
 * - Main content area with background pattern
 * - Footer with links and social media
 * - Cookie consent banner
 * - Scroll-to-top button
 * - View transition support (Astro client-side navigation)
 * - CSP nonce injection for inline scripts
 *
 * Dark Mode:
 * - Applies theme immediately on page load to prevent FOUC
 * - Persists theme across Astro view transitions
 * - Respects system preferences when no stored preference exists
 *
 * @component
 * @example
 * ```astro
 * <PageLayout
 *   locale="en"
 *   title="Page Title"
 *   description="Page description"
 *   permalink="https://example.com/page"
 * >
 *   <h1>Page Content</h1>
 * </PageLayout>
 * ```
 */
import '@/styles/global.css';

import CookieBanner from '@components/svelte/CookieBanner.svelte';
import GoToTop from '@components/svelte/GoToTop.svelte';
import type { Locale } from '@type/locale';
import type { ISEOMetadata } from '@type/seo';

import Footer from './Footer.astro';
import Head from './Head.astro';
import Header from './Header.astro';

/**
 * Props for the PageLayout component.
 *
 * Extends ISEOMetadata to include all SEO-related properties
 * (title, description, permalink, ogImage, articlePublishedTime,
 * articleModifiedTime) plus layout-specific properties like
 * locale and translation path.
 *
 * @see ISEOMetadata For documentation of inherited SEO properties
 */
export interface Props extends ISEOMetadata {
    /**
     * Locale of the page content.
     *
     * Determines the language attribute of the HTML element and affects i18n.
     */
    locale: Locale;

    /**
     * Path to the translated version of this page.
     *
     * Used to generate alternate language links in the header.
     */
    translationPath?: string;
}

const { locale, translationPath, ...seoProps } = Astro.props as Props;
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang={locale}>
    <head>
        <!-- Initialize dark mode immediately to prevent flash and persist across view transitions -->
        <script is:inline nonce={Astro.locals.nonce}>
            function applyTheme() {
                const theme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = theme === 'dark' || (!theme && systemPrefersDark);

                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            // Apply theme immediately on page load
            applyTheme();

            // Reapply the theme after view transitions (client-side navigation)
            document.addEventListener('astro:after-swap', applyTheme);
        </script>

        <Head {...seoProps} locale={locale} />
    </head>

    <body
        class:list={[
            import.meta.env.DEV && 'debug-screens',
            'bg-page-bg text-text-primary dark:bg-page-bg-dark dark:text-text-primary-dark',
        ]}
    >
        <Header locale={locale} currentPath={currentPath} translationPath={translationPath} />

        <main id="main-content" class="bg-dots min-h-screen">
            <slot />
        </main>

        <Footer locale={locale} />

        <GoToTop client:idle />

        <CookieBanner client:idle locale={locale} />
    </body>
</html>
