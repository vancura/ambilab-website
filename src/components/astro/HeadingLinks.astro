---
/**
 * HeadingLinks Component
 *
 * Auto-generates anchor links for headings (h1-h4) in MDX content.
 *
 * Adds clickable anchor links that appear on hover,
 * allowing users to copy direct links to specific sections.
 *
 * Handles duplicate heading text by appending numeric suffixes to IDs.
 *
 * Features:
 * - Automatically processes headings on page load and navigation
 * - Generates URL-safe IDs from heading text
 * - Handles duplicate headings with unique ID generation
 * - Smooth scrolls to anchors and updates URL hash
 * - Copies full URL to clipboard on anchor click
 * - Respects Astro's client-side navigation events
 *
 * @component
 * @example
 * ```astro
 * <HeadingLinks />
 * ```
 */
---

<script>
    import { createLogger } from '@utils/logger';
    import { safeExecute } from '@utils/safe-execute';
    import { smoothScrollTo } from '@utils/scroll';

    declare global {
        interface Window {
            __headingLinksInitialized?: boolean;
        }
    }

    const logger = createLogger({ prefix: 'HeadingLinks' });

    /**
     * Manages the creation and maintenance of anchor links for MDX headings.
     *
     * Tracks used IDs to prevent duplicates and ensures each heading gets
     * a unique anchor link. Refreshes on page load and Astro navigation events.
     */
    class HeadingLinksManager {
        /** Set of IDs that have already been assigned to headings */
        private usedIds: Set<string> = new Set();

        /**
         * Creates a new HeadingLinksManager instance.
         *
         * Binds the refresh method to ensure a correct `this` context
         * when used as an event listener.
         */
        constructor() {
            this.refresh = this.refresh.bind(this);
        }

        /**
         * Generates a URL-safe ID from heading text.
         *
         * Converts text to lowercase, replaces non-alphanumeric characters with
         * hyphens, and ensures uniqueness by appending numeric suffixes when
         * needed.
         *
         * @param text - The heading text content (may be null)
         * @returns A URL-safe ID string, or empty string if text is invalid
         *
         * @example
         * generateId("Hello World!") // Returns "hello-world"
         * generateId("Hello World!") // Returns "hello-world-2" if first already used
         */
        private generateId(text: string | null): string {
            if (!text) {
                return '';
            }

            const baseId = text
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');

            if (!baseId) {
                return '';
            }

            if (!this.usedIds.has(baseId)) {
                this.usedIds.add(baseId);
                return baseId;
            }

            // Find the next available ID with a numeric suffix
            let counter = 2;
            let candidateId = `${baseId}-${counter}`;

            while (this.usedIds.has(candidateId)) {
                counter++;
                candidateId = `${baseId}-${counter}`;
            }

            this.usedIds.add(candidateId);
            return candidateId;
        }

        /**
         * Creates an anchor link element for a heading.
         *
         * Creates a clickable anchor link that:
         * - Smooth scrolls to the heading
         * - Updates the URL hash
         * - Copies the full URL to clipboard
         *
         * @param id - The unique ID of the heading to link to
         * @returns A configured HTML anchor element
         */
        private createAnchor(id: string): HTMLAnchorElement {
            const anchor = document.createElement('a');

            anchor.className = 'anchor';
            anchor.href = `#${id}`;
            anchor.setAttribute('aria-hidden', 'true');
            anchor.textContent = '#';

            anchor.addEventListener('click', (e) => {
                e.preventDefault();

                smoothScrollTo({ targetId: id })
                    .then(({ success, element }) => {
                        if (!success && element) {
                            // Fallback: immediate scroll if smooth scroll failed or timed out
                            logger.warn(`Smooth scroll failed for #${id}, falling back to immediate scroll`);
                            element.scrollIntoView({ behavior: 'auto' });
                        }

                        history.pushState(null, '', `#${id}`);

                        navigator.clipboard.writeText(window.location.href).catch(() => {});
                    })
                    .catch((err) => {
                        logger.error(`Failed to scroll to #${id}`, err);
                    });
            });

            return anchor;
        }

        /**
         * Refreshes anchor links for all headings in MDX content.
         *
         * Scans the page for h1-h4 headings within `.mdx-content`
         * and adds anchor links to any that don't already have them.
         *
         * Resets the used IDs tracker before processing to handle
         * dynamic content updates.
         *
         * Logs the number of headings processed for debugging purposes.
         */
        public refresh(): void {
            this.usedIds.clear();

            const headings = document.querySelectorAll(
                '.mdx-content h1, .mdx-content h2, .mdx-content h3, .mdx-content h4',
            );

            let processedCount = 0;

            headings.forEach((heading) => {
                if (!heading.querySelector('.anchor')) {
                    const id = this.generateId(heading.textContent);

                    if (id) {
                        heading.id = id;
                        heading.insertAdjacentElement('afterbegin', this.createAnchor(id));

                        processedCount++;
                    }
                }
            });

            logger.info(`Processed ${processedCount} new headings (${headings.length} total)`);
        }
    }

    safeExecute(
        () => {
            if (window.__headingLinksInitialized) {
                return;
            }

            window.__headingLinksInitialized = true;

            const manager = new HeadingLinksManager();

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', manager.refresh);
            } else {
                manager.refresh();
            }

            document.addEventListener('astro:page-load', manager.refresh);
        },
        undefined,
        'Failed to initialize HeadingLinks',
    );
</script>

<style>
    :global(.mdx-content h1, .mdx-content h2, .mdx-content h3, .mdx-content h4) {
        position: relative;
    }

    :global(.mdx-content .anchor) {
        position: absolute;
        left: -1.5rem;
        opacity: 0;
        transition: opacity 0.2s;
        text-decoration: none;
        color: var(--color-anchor);
    }

    :global(.mdx-content h1:hover .anchor),
    :global(.mdx-content h2:hover .anchor),
    :global(.mdx-content h3:hover .anchor),
    :global(.mdx-content h4:hover .anchor) {
        opacity: 1;
    }

    :global(.dark .mdx-content .anchor) {
        color: var(--color-anchor-dark);
    }
</style>
