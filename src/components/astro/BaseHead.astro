---
import { getRoute } from '@config/routes';
import { SITE } from '@config/site';
import type { Locale } from '@type/locale';
import type { ISEOMetadata } from '@type/seo';
import { ClientRouter } from 'astro:transitions';

export interface Props extends ISEOMetadata {
    title: string;
    description: string;
    permalink: string;
    ogImage?: string;
    locale?: Locale;
}

const { title, description, ogImage, permalink, locale = 'en' } = Astro.props as Props;

const canonical = permalink.endsWith('/') ? permalink.slice(0, -1) : permalink;
const siteDomain = Astro.url.origin;
const currentDomain = Astro.url.hostname;

// CSP nonce from middleware for inline scripts/styles.
const nonce = Astro.locals.nonce;

// Plausible Analytics configuration
const plausibleScriptCom = import.meta.env.PUBLIC_PLAUSIBLE_SCRIPT_COM;
const plausibleScriptCz = import.meta.env.PUBLIC_PLAUSIBLE_SCRIPT_CZ;
const isComDomain = currentDomain === 'ambilab.com' || currentDomain.endsWith('.ambilab.com');
const isCzDomain = currentDomain === 'ambilab.cz' || currentDomain.endsWith('.ambilab.cz');
const plausibleScript = isComDomain ? plausibleScriptCom : isCzDomain ? plausibleScriptCz : undefined;
---

<ClientRouter />

<link rel="preconnect" href="https://fonts.vancura.dev" crossorigin />
<link rel="dns-prefetch" href="https://fonts.vancura.dev" />

<link
    rel="preload"
    href="https://fonts.vancura.dev/InnovatorGrotesk-Regular.woff2"
    as="font"
    type="font/woff2"
    crossorigin
/>

<link
    rel="preload"
    href="https://fonts.vancura.dev/InnovatorGrotesk-Medium.woff2"
    as="font"
    type="font/woff2"
    crossorigin
/>

<link
    rel="preload"
    href="https://fonts.vancura.dev/InnovatorGrotesk-SemiBold.woff2"
    as="font"
    type="font/woff2"
    crossorigin
/>

<link
    rel="preload"
    href="https://fonts.vancura.dev/InnovatorGrotesk-Bold.woff2"
    as="font"
    type="font/woff2"
    crossorigin
/>

<link rel="preload" href="/fonts/DepartureMono-Regular.woff2" as="font" type="font/woff2" crossorigin />

<style
    is:inline
    nonce={nonce}
    set:html={`
        @font-face {
            font-family: 'Innovator Grotesk';
            src: url('https://fonts.vancura.dev/InnovatorGrotesk-Light.woff2') format('woff2');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Innovator Grotesk';
            src: url('https://fonts.vancura.dev/InnovatorGrotesk-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Innovator Grotesk';
            src: url('https://fonts.vancura.dev/InnovatorGrotesk-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Innovator Grotesk';
            src: url('https://fonts.vancura.dev/InnovatorGrotesk-SemiBold.woff2') format('woff2');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Innovator Grotesk';
            src: url('https://fonts.vancura.dev/InnovatorGrotesk-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Innovator Grotesk';
            src: url('https://fonts.vancura.dev/InnovatorGrotesk-Black.woff2') format('woff2');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }
        }

        @font-face {
            font-family: 'Departure Mono';
            src: url('/fonts/DepartureMono-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
    `}
></style>

{
    import.meta.env.PROD && plausibleScript && (
        <>
            <link rel="preconnect" href="https://plausible.io" />
            <link rel="dns-prefetch" href="https://plausible.io" />
        </>
    )
}

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="canonical" href={canonical} />
<link rel="sitemap" href="/sitemap-index.xml" />
<link rel="alternate" type="application/rss+xml" href={getRoute('rss', locale)} title={`${SITE.NAME} RSS`} />

<title>{title}</title>

<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="generator" content={Astro.generator} />
<meta name="robots" content="index, follow" />
<meta name="author" content={SITE.AUTHOR} />
<meta name="language" content={locale === 'cs' ? 'cs-CZ' : 'en-US'} />

<meta property="og:type" content="website" />
<meta property="og:url" content={permalink} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:site_name" content={SITE.NAME} />
<meta property="og:image" content={ogImage || SITE.DEFAULT_OG_IMAGE} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:locale" content={locale === 'cs' ? 'cs_CZ' : 'en_US'} />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={permalink} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={ogImage || SITE.DEFAULT_OG_IMAGE} />

<link href="/favicon.png" rel="icon" media="(prefers-color-scheme: light)" />
<link href="/favicon-dark.png" rel="icon" media="(prefers-color-scheme: dark)" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content={SITE.NAME} />

<script
    is:inline
    type="application/ld+json"
    nonce={nonce}
    set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'WebSite',
        name: SITE.NAME,
        description: SITE.DESCRIPTION,
        url: siteDomain,
        author: {
            '@type': 'Organization',
            name: SITE.AUTHOR,
            url: SITE.URL,
        },
        publisher: {
            '@type': 'Organization',
            name: SITE.NAME,
            logo: {
                '@type': 'ImageObject',
                url: `${siteDomain}/logo-placeholder.png`,
            },
        },
    })}
/>

{
    import.meta.env.PROD && plausibleScript && (
        <>
            <script is:inline async src={plausibleScript} nonce={nonce} />
            <script
                is:inline
                nonce={nonce}
                set:html={`window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};plausible.init();`}
            />
        </>
    )
}
