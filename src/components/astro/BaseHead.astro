---
import { getRoute } from '@config/routes';
/**
 * BaseHead Component
 *
 * Provides the complete HTML head section with SEO metadata,
 * OpenGraph tags, X Cards, structured data, and analytics.
 *
 * Handles font loading, favicons, and CSP nonce injection
 * for inline scripts and styles.
 *
 * Features:
 * - Comprehensive SEO meta tags (title, description, canonical URL)
 * - OpenGraph and X Card metadata for social sharing
 * - Structured data (JSON-LD) for search engines
 * - Font preloading and optimization (production only)
 * - Analytics integration (Plausible)
 * - Dark mode favicon support
 * - CSP-compliant inline scripts with nonce
 *
 * @component
 * @example
 * ```astro
 * <BaseHead
 *   title="Page Title"
 *   description="Page description"
 *   permalink="https://example.com/page"
 *   locale="en"
 * />
 * ```
 */
import { SITE } from '@config/site';
import type { Locale } from '@type/locale';
import type { ISEOMetadata } from '@type/seo';
import { ClientRouter } from 'astro:transitions';

/**
 * Props for the BaseHead component.
 *
 * Extends ISEOMetadata to include all SEO-related properties.
 */
export interface Props extends ISEOMetadata {
    /** The page title displayed in the browser tab and used for SEO. */
    title: string;

    /** The meta description used for SEO and social media previews. */
    description: string;

    /**
     * The canonical URL for the page.
     * Used to prevent duplicate content issues.
     */
    permalink: string;

    /**
     * Optional OpenGraph image URL for social media sharing.
     * Falls back to the default OG image if not provided.
     */
    ogImage?: string;

    /**
     * Optional locale for the page.
     * Defaults to 'en' if not provided.
     */
    locale?: Locale;
}

const { title, description, ogImage, permalink, locale = 'en' } = Astro.props as Props;

const canonical = permalink.endsWith('/') ? permalink.slice(0, -1) : permalink;
const siteDomain = Astro.url.origin;
const currentDomain = Astro.url.hostname;

// Get the nonce from context for inline scripts/styles (CSP requirement)
// Falls back to undefined if middleware didn't set it (e.g., error paths)
// In that case, CSP headers should allow inline content via 'unsafe-inline'
const nonce = Astro.locals.nonce;

/*
NOTE: All security headers (CSP, X-Content-Type-Options, Permissions-Policy,
etc.) are set via HTTP headers in middleware for better security.

HTTP headers are:
  - Enforced before HTML parsing begins
  - Cannot be modified by injected content
  - More consistently honored across browsers

See: src/middleware.ts and functions/_middleware.ts

NOTE: Only load external font in production to avoid CORS issues in development
*/
---

<ClientRouter />

{
    import.meta.env.PROD && (
        <>
            <link rel="preconnect" href="https://fonts.vancura.dev" crossorigin />
            <link rel="dns-prefetch" href="https://fonts.vancura.dev" />

            <link
                rel="preload"
                href="https://fonts.vancura.dev/InnovatorGrotesk-Medium.woff2"
                as="font"
                type="font/woff2"
                crossorigin
            />
        </>
    )
}

<!-- Font stylesheet with a non-blocking load -->
<!-- In development, use system font fallback to avoid CORS issues -->
{
    import.meta.env.PROD ? (
        <style
            is:inline
            nonce={nonce}
            set:html={`@font-face {
        font-family: 'Innovator Grotesk';
        src: url('https://fonts.vancura.dev/InnovatorGrotesk-Medium.woff2') format('woff2');
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }`}
        />
    ) : (
        <style
            is:inline
            nonce={nonce}
            set:html={`/* Using system font fallback in development to avoid CORS issues */
      :root {
        --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }`}
        />
    )
}

<!-- Analytics preconnect -->
<link rel="preconnect" href="https://plausible.io" />
<link rel="dns-prefetch" href="https://plausible.io" />

<!-- Core meta -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="canonical" href={canonical} />
<link rel="sitemap" href="/sitemap-index.xml" />
<link rel="alternate" type="application/rss+xml" href={getRoute('rss', locale)} title={`${SITE.NAME} RSS`} />

<title>{title}</title>

<!-- SEO meta -->
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="generator" content={Astro.generator} />
<meta name="robots" content="index, follow" />
<meta name="author" content={SITE.AUTHOR} />
<meta name="language" content={locale === 'cs' ? 'cs-CZ' : 'en-US'} />

<!-- OpenGraph -->
<meta property="og:type" content="website" />
<meta property="og:url" content={permalink} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:site_name" content={SITE.NAME} />
<meta property="og:image" content={ogImage || SITE.DEFAULT_OG_IMAGE} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:locale" content={locale === 'cs' ? 'cs_CZ' : 'en_US'} />

<!-- X Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={permalink} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={ogImage || SITE.DEFAULT_OG_IMAGE} />

<!-- Favicons with dark mode support -->
<link href="/favicon.png" rel="icon" media="(prefers-color-scheme: light)" />
<link href="/favicon-dark.png" rel="icon" media="(prefers-color-scheme: dark)" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content={SITE.NAME} />

<!-- Structured Data -->
<script
    is:inline
    type="application/ld+json"
    nonce={nonce}
    set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'WebSite',
        name: SITE.NAME,
        description: SITE.DESCRIPTION,
        url: siteDomain,
        author: {
            '@type': 'Organization',
            name: SITE.AUTHOR,
            url: SITE.URL,
        },
        publisher: {
            '@type': 'Organization',
            name: SITE.NAME,
            logo: {
                '@type': 'ImageObject',
                url: `${siteDomain}/logo-placeholder.png`,
            },
        },
    })}
/>

<!-- Plausible Analytics -->
{import.meta.env.PROD && <script defer data-domain={currentDomain} src="https://plausible.io/js/script.js" />}
