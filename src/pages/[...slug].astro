---
import BlogPostLayout from '@components/astro/BlogPostLayout.astro';
import PageLayout from '@components/astro/PageLayout.astro';
import { DEFAULT_LOCALE } from '@i18n/config';
import { getTranslation } from '@i18n/translations';
import type { Locale } from '@type/locale';
import { formatDate } from '@utils/formatDate';
import { createLogger } from '@utils/logger';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';

const logger = createLogger({ prefix: 'ContentPage' });
const detectedLocale = Astro.locals.locale ?? DEFAULT_LOCALE;
const { slug } = Astro.params;
const requestPath = slug || 'index';
const isBlogIndex = requestPath === 'blog';
const isBlogPost = requestPath.startsWith('blog/');
const actualSlug = isBlogPost ? requestPath.replace('blog/', '') : requestPath;

let renderType: 'blog-index' | 'blog-post' | 'page' | 'not-found' | 'error';
let entry: CollectionEntry<'blog'> | CollectionEntry<'pages'> | undefined;
let sortedBlogPosts: CollectionEntry<'blog'>[] = [];
let Content: any;
let locale: Locale = detectedLocale;
let siteUrl = Astro.url.origin;
let permalink = '';

try {
    if (isBlogIndex) {
        const blogPosts = await getCollection(
            'blog',
            (entry: CollectionEntry<'blog'>) => !entry.data.draft && entry.data.locale === detectedLocale,
        );

        sortedBlogPosts = blogPosts.sort(
            (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) =>
                b.data.pubDate.getTime() - a.data.pubDate.getTime(),
        );

        permalink = `${siteUrl}/blog`;
        renderType = 'blog-index';
    } else if (isBlogPost) {
        const blogPosts = await getCollection(
            'blog',
            (entry: CollectionEntry<'blog'>) => !entry.data.draft && entry.data.locale === detectedLocale,
        );

        entry = blogPosts.find((e: CollectionEntry<'blog'>) => {
            const entrySlug = e.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');

            return entrySlug === actualSlug;
        });

        if (entry) {
            const rendered = await entry.render();

            Content = rendered.Content;
            locale = entry.data.locale;

            const entrySlug = entry.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');

            permalink = `${siteUrl}/blog/${entrySlug}`;
            renderType = 'blog-post';
        } else {
            renderType = 'not-found';
        }
    } else {
        const pages = await getCollection(
            'pages',
            (entry: CollectionEntry<'pages'>) => entry.data.locale === detectedLocale,
        );

        entry = pages.find((e: CollectionEntry<'pages'>) => {
            const entrySlug = e.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');

            return entrySlug === actualSlug;
        });

        if (entry) {
            const rendered = await entry.render();

            Content = rendered.Content;
            locale = entry.data.locale;

            const entrySlug = entry.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');

            permalink = `${siteUrl}/${entrySlug === 'index' ? '' : entrySlug}`;
            renderType = 'page';
        } else {
            renderType = 'not-found';
        }
    }
} catch (error) {
    logger.error(`Failed to load content for path: ${requestPath}`, error);

    renderType = 'error';
}

if (renderType === 'error') {
    return Astro.redirect('/500');
}

if (renderType === 'not-found') {
    return Astro.redirect('/404');
}

const t = getTranslation(detectedLocale);

let translationPath: string | undefined;

if (renderType === 'blog-index') {
    translationPath = '/blog';
} else if (renderType === 'page' && entry) {
    if (actualSlug === 'index') {
        translationPath = '/';
    } else if (entry.data.translationSlug) {
        translationPath = `/${entry.data.translationSlug}`;
    }
} else if (renderType === 'blog-post' && entry && entry.data.translationSlug) {
    translationPath = `/blog/${entry.data.translationSlug}`;
}
---

{
    renderType === 'blog-index' ? (
        <PageLayout
            title={`${t.blog.title} | Ambilab`}
            description={t.blog.description}
            permalink={permalink}
            locale={locale}
            {...(translationPath ? { translationPath } : {})}
        >
            <div class="container mx-auto px-4 py-12">
                <div class="mx-auto max-w-4xl">
                    <h1 class="mb-4 text-4xl font-bold">{t.blog.title}</h1>
                    <p class="mb-12 text-xl text-text-muted dark:text-text-muted-dark">{t.blog.description}</p>

                    {sortedBlogPosts.length === 0 ? (
                        <p class="text-text-muted dark:text-text-muted-dark">{t.blog.noPosts}</p>
                    ) : (
                        <div class="space-y-8">
                            {sortedBlogPosts.map((post) => {
                                const postSlug = post.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');
                                const postUrl = `/blog/${postSlug}`;

                                return (
                                    <article class="border-b border-border-default pb-8 last:border-b-0 dark:border-border-default-dark">
                                        <a href={postUrl} class="group">
                                            <h2 class="mb-2 text-2xl font-bold group-[&:hover,&:focus]:text-link-hover dark:group-[&:hover,&:focus]:text-link-hover-dark">
                                                {post.data.title}
                                            </h2>
                                        </a>

                                        <div class="mb-3 flex items-center gap-4 text-sm text-text-muted dark:text-text-muted-dark">
                                            <time datetime={post.data.pubDate.toISOString()}>
                                                {formatDate(post.data.pubDate, locale)}
                                            </time>
                                            {post.data.tags.length > 0 && (
                                                <div class="flex flex-wrap gap-2">
                                                    {post.data.tags.map((tag: string) => (
                                                        <span class="rounded-full bg-tag-bg px-3 py-1 text-xs text-tag-text dark:bg-tag-bg-dark dark:text-tag-text-dark">
                                                            {tag}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        <p class="mb-4 text-text-secondary dark:text-text-secondary-dark">
                                            {post.data.description}
                                        </p>

                                        <a
                                            href={postUrl}
                                            class="[&:hover,&:focus]:text-link-hover dark:[&:hover,&:focus]:text-link-hover-dark inline-flex items-center font-medium text-link dark:text-link-dark"
                                        >
                                            {t.buttons.readMore} â†’
                                        </a>
                                    </article>
                                );
                            })}
                        </div>
                    )}
                </div>
            </div>
        </PageLayout>
    ) : renderType === 'page' && entry ? (
        <PageLayout
            title={`${entry.data.title} | Ambilab`}
            description={entry.data.description}
            permalink={permalink}
            locale={locale}
            {...(translationPath ? { translationPath } : {})}
        >
            <article class="container mx-auto px-4 py-12">
                <div class="mdx-content prose prose-lg mx-auto max-w-4xl dark:prose-invert">
                    <Content />
                </div>
            </article>
        </PageLayout>
    ) : renderType === 'blog-post' && entry ? (
        <BlogPostLayout
            title={`${entry.data.title} | Ambilab`}
            description={entry.data.description}
            permalink={permalink}
            locale={locale}
            pubDate={entry.data.pubDate}
            updatedDate={entry.data.updatedDate}
            author={entry.data.author}
            tags={entry.data.tags}
            content={entry.body}
            {...(translationPath ? { translationPath } : {})}
        >
            <Content />
        </BlogPostLayout>
    ) : null
}
