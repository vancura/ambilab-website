---
import NewsList from '@components/astro/NewsList.astro';
import NewsPostLayout from '@components/astro/NewsPostLayout.astro';
import NewsSection from '@components/astro/NewsSection.astro';
import PageLayout from '@components/astro/PageLayout.astro';
import { DEFAULT_LOCALE } from '@i18n/config';
import { getTranslation } from '@i18n/translations';
import { resolveContent } from '@utils/content-resolver';
import { createLogger } from '@utils/logger';
import { parseRoute } from '@utils/route-parser';

const logger = createLogger({ prefix: '[...slug]' });
const detectedLocale = Astro.locals.locale ?? DEFAULT_LOCALE;
const route = parseRoute(Astro.params.slug);

let resolvedContent;
try {
    resolvedContent = await resolveContent(route, detectedLocale, Astro.url.origin);
} catch (err) {
    logger.error('Failed to resolve content', { route, detectedLocale, error: err });
    return Astro.redirect('/500');
}

if (!resolvedContent) {
    return Astro.redirect('/404');
}

const t = getTranslation(detectedLocale);
---

{
    resolvedContent.type === 'news-index' ? (
        <PageLayout
            title={`${t.news.title} | Ambilab`}
            description={t.news.description}
            permalink={resolvedContent.permalink}
            locale={resolvedContent.locale}
            pageMap={resolvedContent.content.pageMap}
            translationPath={resolvedContent.translationPath}
        >
            <div class="container mx-auto px-4 py-12">
                <div class="mx-auto max-w-4xl">
                    <h1 class="mb-4 text-4xl font-bold">{t.news.title}</h1>
                    <p class="mb-12 text-xl text-text-muted">{t.news.description}</p>
                    <NewsList posts={resolvedContent.sortedNewsPosts} locale={resolvedContent.locale} />
                </div>
            </div>
        </PageLayout>
    ) : resolvedContent.type === 'page' ? (
        <PageLayout
            title={`${resolvedContent.entry.data.title} | Ambilab`}
            description={resolvedContent.entry.data.description}
            permalink={resolvedContent.permalink}
            locale={resolvedContent.locale}
            pageMap={resolvedContent.content.pageMap}
            {...(resolvedContent.translationPath ? { translationPath: resolvedContent.translationPath } : {})}
        >
            <article class="container mx-auto px-4 pb-[36px] sm:pb-[40px] md:pb-[48px]">
                <div class="mdx-content prose prose-lg mx-auto max-w-4xl dark:prose-invert">
                    <resolvedContent.Content />
                </div>
            </article>

            {route.slug === 'index' && (
                <div class="container mx-auto px-4 pb-[36px] sm:pb-[40px] md:pb-[48px]">
                    <div class="mx-auto max-w-4xl">
                        <NewsSection locale={resolvedContent.locale} limit={3} />
                    </div>
                </div>
            )}
        </PageLayout>
    ) : (
        <NewsPostLayout
            title={`${resolvedContent.entry.data.title} | Ambilab`}
            description={resolvedContent.entry.data.description}
            permalink={resolvedContent.permalink}
            locale={resolvedContent.locale}
            pubDate={resolvedContent.entry.data.pubDate}
            updatedDate={resolvedContent.entry.data.updatedDate}
            tags={resolvedContent.entry.data.tags}
            content={resolvedContent.entry.body}
            pageMap={resolvedContent.content.pageMap}
            {...(resolvedContent.translationPath ? { translationPath: resolvedContent.translationPath } : {})}
        >
            <resolvedContent.Content />
        </NewsPostLayout>
    )
}
