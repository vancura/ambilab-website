---
import { getCollection } from 'astro:content';
import PageLayout from '@components/astro/PageLayout.astro';
import BlogPostLayout from '@components/astro/BlogPostLayout.astro';
import type { Locale } from '@type/locale';
import { defaultLocale } from '@i18n/config';

// Get the detected locale from middleware (via context.locals)
const detectedLocale = Astro.locals.locale || defaultLocale;

// Get the slug from URL
const { slug } = Astro.params;
const requestPath = slug || 'index';

// Determine if it's a blog post or page
const isBlogPost = requestPath.startsWith('blog/');

// Extract the actual slug (remove blog/ prefix if present)
const actualSlug = isBlogPost ? requestPath.replace('blog/', '') : requestPath;

// Fetch the appropriate collection, filtered by detected locale
let entry;
let type: 'page' | 'blog';

if (isBlogPost) {
  const blogPosts = await getCollection('blog', ({ data }) => 
    !data.draft && data.locale === detectedLocale
  );
  entry = blogPosts.find((e) => {
    const entrySlug = e.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');
    return entrySlug === actualSlug;
  });
  type = 'blog';
} else {
  const pages = await getCollection('pages', ({ data }) => 
    data.locale === detectedLocale
  );
  entry = pages.find((e) => {
    const entrySlug = e.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');
    return entrySlug === actualSlug;
  });
  type = 'page';
}

// 404 if not found
if (!entry) {
  return Astro.redirect(`/404?locale=${detectedLocale}`);
}

const { Content } = await entry.render();

const locale: Locale = entry.data.locale;
const siteUrl = Astro.url.origin;
const entrySlug = entry.id.replace(/\.(mdx|md)$/, '').replace(/^[^/]+\//, '');
const permalink = `${siteUrl}/${entrySlug === 'index' ? '' : entrySlug}`;
---

{
  type === 'page' ? (
    <PageLayout
      title={`${entry.data.title} | ambilab`}
      description={entry.data.description}
      permalink={permalink}
      locale={locale}
    >
      <article class="container mx-auto px-4 py-12">
        <div class="prose prose-lg mx-auto max-w-4xl dark:prose-invert mdx-content">
          <Content />
        </div>
      </article>
    </PageLayout>
  ) : type === 'blog' ? (
    <BlogPostLayout
      title={`${entry.data.title} | ambilab`}
      description={entry.data.description}
      permalink={permalink}
      locale={locale}
      pubDate={entry.data.pubDate}
      updatedDate={entry.data.updatedDate}
      author={entry.data.author}
      tags={entry.data.tags}
      content={entry.body}
    >
      <Content />
    </BlogPostLayout>
  ) : null
}

