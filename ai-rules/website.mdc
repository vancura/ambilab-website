---
description: Core project rules for Ambilab marketing website
globs: ['**/*']
alwaysApply: true
---

# Ambilab Website Project Rules

A bilingual (English/Czech) marketing website and news for Ambilab.

## CRITICAL RULES

### No Emoji

NEVER use emoji in:

- Source code (comments, strings, identifiers)
- Documentation (Markdown files, JSDoc)
- Commit messages
- Pull request titles and descriptions
- Error messages or log output

This rule has no exceptions. Use plain text descriptions instead.

**What to avoid:**

- Emoji characters: `ðŸ“·`, `ðŸ˜`, `ðŸ¦‹`, `ðŸ”’`, `âœ…`, `âŒ`
- Unicode decorative characters: `ð•`, `â—ˆ`, `âœ“`, `âœ—`
- Emoji shortcodes: `:rocket:`, `:fire:`, `:check:`

**What to use instead:**

- For status indicators: Use text labels like `[PASS]`, `[FAIL]`, `[SUCCESS]`, `[ERROR]`
- For visual markers: Use plain text like `Completed`, `Failed`, or semantic HTML

**Why this matters:**

- Screen reader experience: Emoji may be announced inconsistently or verbosely
- Visual consistency: Emoji renders differently across platforms and fonts
- Professionalism: Plain text is clearer and more maintainable

### TypeScript Strict Mode

All code must pass strict TypeScript checks:

- `strict: true` with all strict sub-options enabled
- No `any` types unless absolutely necessary (use `unknown` instead)
- Proper null/undefined handling with optional chaining
- Type-only imports for interfaces and type aliases

## Architecture

### Tech Stack

- **Framework**: Astro 5 with SSR (Cloudflare adapter)
- **UI Components**: Svelte 5 (hydratable)
- **Styling**: Tailwind CSS 4 with a custom theme
- **Language**: TypeScript (strict mode)
- **Content**: MDX via Astro Content Collections
- **Code Highlighting**: Expressive Code (Shiki-based)
- **Package Manager**: pnpm
- **Deployment**: Cloudflare Pages
- **Linting**: Biome + ESLint + Prettier

### Project Structure

```text
website/
  functions/              # Cloudflare Pages edge functions (advanced mode)
  public/                 # Static assets (favicons, OG images)
  src/
    components/
      astro/             # Astro-only components
      svelte/            # Interactive Svelte components
    config/              # Site, security, component config
    content/
      news/              # News posts by locale (en/, cs/)
      pages/             # Static pages by locale
    i18n/                # Locale config, translations, utils
    lib/                 # Reusable libraries (images)
    pages/               # Astro pages and API routes
    scripts/             # Utility scripts
    styles/              # Global and MDX styles
    types/               # TypeScript type definitions
    utils/               # Utility functions
    middleware.ts        # Locale detection, security headers
    env.d.ts             # Environment types
```

### Bilingual Content

The site supports English and Czech with domain-based detection:

- `ambilab.com` -> English
- `ambilab.cz` -> Czech
- Localhost -> English (default)

**Detection Priority:**

1. Cookie override (`locale` cookie)
2. Domain/hostname detection
3. Default fallback (en)

**Content Translation Linking:**

Each MDX file links to its translation via frontmatter:

```yaml
---
title: 'Hello World'
locale: 'en'
translationSlug: 'ahoj-svete'
---
```

## Component Patterns

### Astro Components

Located in `src/components/astro/`. Server-rendered by default, import Svelte with `client:*` directives:

```astro
---
import Button from '@components/svelte/Button.svelte';
---

<Button client:load>Click me</Button>
```

### Svelte Components

Located in `src/components/svelte/`. Interactive, hydratable, typed with `$props()`:

```svelte
<script lang="ts">
  interface Props {
    variant?: 'primary' | 'secondary';
    disabled?: boolean;
  }
  let { variant = 'primary', disabled = false }: Props = $props();
</script>
```

### Component Hydration

- `client:load` - Immediate (interactive elements)
- `client:visible` - When visible (below fold)
- `client:idle` - When browser idle
- `client:only="svelte"` - Skip SSR

## Content Collections

### News Posts

Schema defined in `src/content/config.ts`:

```typescript
const newsCollection = defineCollection({
  type: 'content',
  schema: z.object({
    title: z.string(),
    description: z.string(),
    locale: z.enum(['en', 'cs']),
    translationSlug: z.string().optional(),
    pubDate: z.coerce.date(),
    updatedDate: z.coerce.date().optional(),
    author: z.string().default('Ambilab'),
    tags: z.array(z.string()).default([]),
    draft: z.boolean().default(false),
  }),
});
```

Note: `z.coerce.date()` automatically converts date strings from frontmatter to Date objects.

### Adding Content

1. Create MDX file in `src/content/news/en/` or `src/content/news/cs/`
2. Add frontmatter with required fields
3. Link translations via `translationSlug`
4. Write content in MDX

## Security

### CSP and Security Headers

Configured in `src/config/security.ts` and applied via `src/middleware.ts`:

- Content Security Policy with nonce support
- X-Content-Type-Options, X-Frame-Options, X-XSS-Protection
- Referrer-Policy, Permissions-Policy
- Environment-aware (relaxed in development)

### Demo Embeds

Use the `DemoEmbed` component for sandboxed iframes with strict URL allowlist. The component provides security
validation and automatically applies safe iframe sandbox permissions.

#### Basic Usage

```astro
---
import DemoEmbed from '@components/svelte/DemoEmbed.svelte';
---

<DemoEmbed src="https://blit-tech-demos.ambilab.com/demo/example" title="Interactive Example Demo" client:visible />
```

#### Configuration Options

```astro
<DemoEmbed
  src="https://blit-tech-demos.ambilab.com/demo/example"
  title="Demo caption"
  aspectRatio="4/3"
  class="my-custom-class"
  desktopOnly={false}
  allowAutoplay={true}
  allowMotionSensors={false}
  allowTopNavigation={false}
  client:visible
/>
```

#### Security Notes

- Only URLs from allowlisted hostnames are accepted (currently: `blit-tech-demos.ambilab.com`)
- All URLs must use HTTPS protocol
- To add new hostnames, update `allowedHostnames` in the component after security review
- Invalid URLs will display a warning message instead of embedding

## Styling

### Tailwind CSS 4

- A dark mode with class strategy
- Custom theme in `tailwind.config.ts`
- Typography plugin for prose content

### Semantic Design Tokens

The project uses semantic design tokens with automatic dark mode switching:

- **CSS Custom Properties**: Defined in `src/styles/global.css` using `@theme` and `.dark` selector
- **Tailwind Utilities**: Mapped in `tailwind.config.ts` theme.extend.colors
- **Usage**: Use single semantic classes like `text-text-muted`, `bg-surface`, `border-border-default`
- **Dark Mode**: Colors automatically switch when `.dark` class is applied to the document

**Available token categories:**

- `page-bg` - Page backgrounds
- `surface` / `surface-code` - Component surfaces
- `border-default` / `border-medium` / `border-subtle` - Border colors
- `text-primary` / `text-secondary` / `text-muted` - Text colors
- `link` / `link-hover` / `link-active` - Link colors and states
- `button-primary-*` / `button-secondary-*` / `button-outline-*` - Button colors
- `tag-bg` / `tag-text` - Tag/badge colors

**No `-dark` variants needed**: CSS variables automatically change values based on `.dark` class, so you only need one
class name (e.g., `bg-page-bg` works for both light and dark modes)

### CSS Organization

- Global styles in `src/styles/global.css`
- MDX content styles in `src/styles/mdx-content.css`
- Component-specific styles via Tailwind utilities

## Code Style

### Formatting

Enforced by Biome (TS/JS/JSON/CSS) and Prettier (Astro/Svelte/Markdown):

- **Indent**: four spaces (two for JSON/YAML/Markdown)
- **Line width**: 120 characters max
- **Quotes**: Single quotes for strings
- **Semicolons**: Always required
- **Trailing commas**: Always

### Imports

Use type imports for type-only imports:

```typescript
import type { NewsPost } from '@type/content';
import { createLogger } from '@utils/logger';
```

### Path Aliases

- `@/*` - src/\*
- `@components/*` - src/components/\*
- `@config/*` - src/config/\*
- `@lib/*` - src/lib/\*
- `@utils/*` - src/utils/\*
- `@type/*` - src/types/\*
- `@i18n/*` - src/i18n/\*

## Git Commits

### Conventional Commits

Format: `<type>(<scope>): <description>`

**Rules:** Header max 100 chars, lowercase subject, no period at the end, body wraps at 72 chars.

**Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`

**Scopes:** `news`, `i18n`, `components`, `seo`, `security`, `api`, `ci`, `docs`

### AI-Assisted Commits

Include trailer: `Co-Authored-By: Claude <noreply@anthropic.com>`

## Development Commands

```bash
pnpm dev              # Start development server
pnpm build            # Build for production
pnpm preview          # Preview production build
pnpm check            # Run Astro check
pnpm lint             # Lint code
pnpm lint:fix         # Fix linting issues
pnpm format           # Format code
pnpm format:check     # Check formatting
pnpm typecheck        # Run TypeScript checks
pnpm spellcheck       # Check spelling
pnpm preflight        # Run all quality checks
pnpm sync-rules       # Sync AI rules to editor configs
```

## Agent Automation

This project uses Cursor agent hooks and skills for automated quality assurance.

### Automatic Stop Hook

When agents complete tasks, a stop hook automatically:

- Formats code with `pnpm format`
- Runs `pnpm typecheck` to catch type errors
- Reports issues and requests fixes (max 3 iterations)
- Ensures code quality without manual intervention

### Available Skills

- `/format` - Format code and verify
- `/preflight` - Run all quality checks (format, lint, typecheck, spellcheck, knip)
- `/pr <description>` - Create PR with automatic commit and quality checks
- `/review` - Review changes against project rules

See `ai-rules/agent-workflow.mdc` for detailed workflow guidance.

### Configuration

- Hooks: `cursor-config/hooks.json` and `cursor-config/hooks/`
- Skills: `cursor-config/skills/*/SKILL.md`
- Sync: Run `pnpm sync-rules` to copy from `cursor-config/` to `.cursor/`

## Common Mistakes to Avoid

1. **Using emoji** â€“ Never allowed anywhere
2. **Forgetting hydration directives** â€“ Svelte components need `client:*`
3. **Missing translations** â€“ Always create both en/cs versions
4. **Skipping frontmatter fields** â€“ Required fields must be present
5. **Using `any` type** â€“ Use proper types or `unknown`
6. **Hardcoding strings** â€“ Use `src/i18n/translations.ts`
7. **Hardcoding colors** â€“ Use semantic design tokens (single class names, no `dark:` variants needed)
8. **Missing alt text** â€“ All images need alt attributes
9. **Ignoring reduced motion** â€“ Animations must respect `prefers-reduced-motion`
